import {expect} from 'chai';
import {ethers} from 'hardhat';

function byteArrayToNibbleArray(byteArray: Uint8Array): number[] {
	const result: number[] = Array.from({length: byteArray.length * 2});

	for (const [i, byte] of byteArray.entries()) {
		result[i * 2] = byte >> 4;
		result[(i * 2) + 1] = byte & 0x0F;
	}

	return result;
}

describe('Proveth state proofs', () => {
	async function deployProveth() {
		// Contracts are deployed using the first signer/account by default
		const owner = await ethers.getSigner();

		// On Ethereum
		const verifierFactory = await ethers.getContractFactory('ProvethVerifier');
		const verifier = await verifierFactory.deploy();
		await verifier.deployed();

		return {owner, verifier};
	}

	describe('Token deployment', () => {
		it('Should validate a Merkle-Patricia proof', async () => {
			const {owner, verifier} = await deployProveth();
			// {"cat": "Nibbles", "name": "Jonas"}
			const result = await verifier.exposedValidateMPTProof('0x4eea4a6f6d8c8f38916be012f4a59cb2d57be056b17d65a9be42d3967389f650',
				ethers.utils.hexlify(byteArrayToNibbleArray(ethers.utils.arrayify('0x636174'))),
				ethers.utils.RLP.encode([
					['0x16', '0x39a7f356226f5cf3754fb4dac8c325b308f7eb49dd709d7fbca74717fbc9264d'],
					['0x', '0x', '0x', ['0x206174', '0x4e6962626c6573'], '0x', '0x', '0x', '0x', '0x', '0x', '0x', '0x', '0x', '0x', ['0x20616d65', '0x4a6f6e6173'], '0x', '0x'],
					['0x206174', '0x4e6962626c6573'],
				]),
			);
		});

		it('Should prove the number of tokens held in a storage trie', async () => {
			const {owner, verifier} = await deployProveth();

			const storageSlot = '0x1b78f95ce9c545113830f6f7eec96f49712a408da3b4b03d72d06260f909dc15';
			const keyInStorageTrie = ethers.utils.keccak256(storageSlot);
			const keyNibbles = ethers.utils.hexlify(byteArrayToNibbleArray(ethers.utils.arrayify(keyInStorageTrie)));
			const result = await verifier.exposedValidateMPTProof('0x210c77b5d616c75b1106ab99dfea0670395e26fe4e3f16194c3a77b79eeaf283',
				keyNibbles,
				ethers.utils.RLP.encode([
					'0xf90211a0e1708e9ae46c09f48d1a357720b2598708a4a8828f76e2131db17d67d6c76407a0fc144ea47110100fee490c066d08ae164610d96f3f99549cded6a202999e6befa077baaa34645aefa585d51997db184372be9204d6990bb40462bcdedc2a51d21ca0184979cefb9e149eb9c639ada97c0a065d1e4035ed03131aa7945e06c31a3fbaa0c3edf55247a4bb0d0f43dc6787076997f2e87488854f6dbde168c96dea698c99a018a9566aaa49b4d064b68ca7122ee8cf1d365111e9235d285fcb634241d35317a00b53a04700434bfca5a679974952dae63bd12543ae953f445336932aba708462a011fd1c963383d12b89fac93bcd820e0486454d60e8fec85e13d59e5ef9d15810a05e7b3e9791c6bac9da7952e12ed9df04cbd2a3be2684ffdc97950800504281f9a042fe1097796a522f6afd5a262ab214a71264bd0786a4b95f1da74f431fb46123a0ac09a2db5e83b8a34b35cfd6c5288cce68129f45418b698c4fc3b53948357911a08e94cc8484130653984bc6035503a1719b2e882a11bd1441ac85e32148630ee6a09cb80f369f78116eb505337a5ea07d1ca3a31f17155f3bae1141109241d9aa5da0f849ff06e20a1617d749847e6b4cc424fc0b4bc69d6733c2afd5b2bee80c8613a0871c7e82e1888c6b162f4d632704349766f0fdae82add6a67e69134a9c36996aa0f6c6103d824953026feba409a0548a44098ae93cfe7689fde88119e42b669c5d80',
					'0xf90211a01da3c73865dcfc510dc8e169412504e6ad445ecb4e2c1adba207c0174790c757a0352c5cb95078cdb872dea09238b4cc9fe3aa8d50e70181c0bffcdae2b40b54f4a0ce995796573ea33aaa30b3fcbaa4fc89d89d86d13d972c65b62945e960c61603a09c017fbaade9f6a1ae510260cff77004862acff6711757b3b3a883beaa2e24d8a09ee5f24b29a3ffa055e0b5eef66696c544b8117fe330b2b6289b4cdc9e0fddf5a056db197631850c2bdbf0e5bf8ad58b22ba17d44232f536efe37cc0ba7befec8ea0bbc8d1155023eed2388c53e3eb8fed353990829136432c4a0498aa683f9de807a0c6fbe1ea672e50618fb40999725cad4496314bb32297d1e904ec41fddcffbaf2a0f9eb816dc25794d5c39e48842cd6f3c45935d7b58842af0dc32ff6a4aee76a8ba01a914bde36e70ea592d4e5d170580a90fd55f88eabeadc1e233f2bd45f317ccca0864807d69c4d6fd05f79f592cb3fb9a17f3b4f0a84d708bd683576232e44cf01a0263d171a75ed30557830659df167f0837c8c4c3e2b8ceb798b30177582b4004ea09a66d15fe53c7ec229627ee86a9c0c94ca48f262de5e2dcd0c865e27eea3b908a00878a80cd9731ca42a811967a69b3f8169d3493d93cd012b7f7189a9369d0ce2a01b51167a29d469dafc9f69cc0a5d635580d2e4adbc6971aff5631c1ab861e6c0a000636acbf3135e7d8cd82af8950fcd92eb1151a0cd01173cf72a314dcc23e29180',
					'0xf90211a04c1c50de914e7e661cecfea797a9712128ff000886825b53038e3f258341514ca0680052e14d4aebd5a40297f92c80679c8b5e8e4e865fb668ad9e7365bd159befa0b162d1bfd9be32c724dc991cb3b08a6953ed4ffb23d5d2b69b9739250638212da02126cdcccd6bd541335ebc0a8ef8f699a40f90c438ec78b488723479bb3cafe7a0d3a747f2293740e97cbca8543efa2f0c7bab0de28485a96d52b477992fd549e9a0d354c24e608fbe96b12875c8d6dd24589c93ea1524e2a079b2931361a3352046a04019decc16f5f57b70521ab362e8136a2f5acc1ef9bf0ae1372c133980a9c5e7a0eca605b65a4db44fe55673ed54f6eede0d652343c67e64b917cff8a3bd3e543fa068a180505f7a51adb6ef58ae0a0e7d357ae7824d8f0a6d7879b2535d49f16733a022dd33aff9fb5cfab7c6869e273425e442d7b1d11aab79c25c548f7cac963712a062454ab4f04474bb4e97976cf3d6675eda49c36e9fd09e6d7b2f9622471a505ca0f75751fe93f607b66dc8605fca9f60fd33ddfd740273c9cf2a97e908a3de99a9a0459a3c77f258f284a7d29ce4857bf3ebb5e31bc7f5acfd0ab164c9d593f18794a092be6bc17390a58a1bc6894ee8bcdf6ee99d79039dce505a295d7ff3818b1963a00d622068900aa80f21a94bc2ec19f3f524a76e627c6cb9ae96b63e52e28f902ba08f714cf62e256c8a30dd46095e8ec3558d1490bba141195fabb36918531313ec80',
					'0xf90211a0a3744baf344a520aa1f4b04fc43bb443df6a53179099976a2d181c65de9501aea084f1a8dcf8e622df03d6c48a2a18a1096ed0d2121a11e82470927b6d972d7263a0f34592788176ebf77988048f952cf523ba8dcb7ed111eb669573c462f685f1f1a0326dbc60ce17e2fa2812353b63d227c8c3c6261761048badf773939617e466f6a0b4c39a874adf735ecec82110ad0e19564c9558b2e06fa78da4f4eb687864eac6a08797db9eca3d334c7e415424c8e8b0d075f1152fe1d956d0751b788369a06596a04fd34207086a538a0ae34fab90e0e8c70df6f0784ff703de70df8b231cf39c4ea07b9861c22eef80a2634e84856125bc191d02da9042ca7a36945aeba1bd5c1b7da0c87fe324fa196dbfbf180e01dc7c1479a8c49c46e488142605b859e98f59555ea0e9689b75d3499e8be47212d9dc702ee254b160e6d8e82fe60ee4c19e0f88ad2ba0b59105d7bd20c92dd9d1148613e223e072a361151775a4695f6f4cbd040cd6e8a0d8ce2dc72ff88f3acbf4fc9527b1c3c2723f996a3eb80321c5787eb511ddae31a0b3ac38a4ff8e9dd9d3d9d3a1a59332a6a4ba0a79a65afff858f1a6cbf82699aea0c1584add01851fcc0033b3049645d2768a68bf447a813c93f263af841d2d3fa0a0da14d366a634e2ce3b156ca8957ea808dbb99c65004cad3823f236f6545283f1a0b1f9d687067d9433dd00f7e91694a6db5990db73d017bc44037760318fa9a36180',
					'0xf901f1a04992c81fb7c2a4b738a0ec859a605175908d25b56f0eb2593a26fc8e435e471fa079b6e90459978f99a69409ffbb322b9786c4d86f454249a3e51e4dad9199a837a0826da9a0342abba983f1842dd0b0b9f6277394f9bfd942572900f3162bea07b7a0d697338cf762f079fbf49fa8190c527df0332ef6ef8b0b5b09c50645a3e9f467a0e4d3ff4fc0f96d53ab2dd7cdc84607c49cbc3922fa5bd81b647cf02873459807a018e2eed7e9941f5e82b65c8ae200bd0d02cf3b4cba05bff70d8e43aca68cf2d8a08a14ae3ff750400e88b4d81548d091e4ac88d6630f6e0f7725458a79c31d30d5a09534ee5da3538598c35e2110151511b4ea2e9b92f46152414504ad897f9b50d9a0b1201e6fc5bb4db20a66fdfbbcac796655b28c5f923133302ac3f56b2cf91041a0149aa97e47f15598d0ff0f4e45fbaf2829ea94126c4643c2fe15fccad32f5899a0387ab17c97edf208417b152125f5c95746b6b1ff96f10407dfd9f943d99651a3a03baa7861b45607cfb7a073e3c07467975a80e56b1a07fd25e7e96adbf115d1e8a00f1a754ca5facc4f992306041749e671525c4c271e88f8854f31efc381e75587a0cff8384434743845d5bf2388ee31038825e3cd963758c3982e9d0e9261e266f7a0ebd776dfc2458ede9c4f954fe306fb2e4d4f25c80996cf36eef63e550d99443f8080',
					'0xf85180808080808080a0aea5b54b4753e20156167a1ad8a4b9aa6d642012827f3b207f49fe0d9463725f80808080a0f6d02b1dbd6e8acc0e60675a55b79bf37d086b9c96977d0d95c205c2f51323a180808080',
					'0xe69e20cac85c956f3fe5b47d29bdd0020f90496bfcabacc562285f43b29079bc8685bba737b000',
				].map(rlpValue => ethers.utils.RLP.decode(rlpValue))),
			);
			console.log(`User has ${ethers.utils.formatEther(result)} DAI`);
		});
	});
});
